#!/usr/bin/env node
/**
 * Install Git Hooks for Automatic Environment Maintenance
 * 
 * This script installs git hooks that automatically maintain the environment:
 * - pre-commit: Runs environment checks before commits
 * - post-merge: Cleans environment after merges
 * - post-checkout: Updates environment after branch switches
 */

import { writeFileSync, existsSync, mkdirSync, chmodSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = join(__dirname, '..');
const hooksDir = join(rootDir, '.git', 'hooks');

// Ensure hooks directory exists
if (!existsSync(hooksDir)) {
  mkdirSync(hooksDir, { recursive: true });
}

// Pre-commit hook - verify environment is clean
const preCommitHook = `#!/bin/sh
# Auto-generated by install-git-hooks.mjs
# Runs environment maintenance before commits

echo "ü¶ä Running pre-commit environment checks..."
node scripts/maintain-environment.mjs --check-only

exit 0
`;

// Post-merge hook - clean environment after merges
const postMergeHook = `#!/bin/sh
# Auto-generated by install-git-hooks.mjs
# Cleans environment after merges

echo "ü¶ä Cleaning environment after merge..."
node scripts/maintain-environment.mjs

exit 0
`;

// Post-checkout hook - update environment after branch switches
const postCheckoutHook = `#!/bin/sh
# Auto-generated by install-git-hooks.mjs
# Updates environment after branch switches

echo "ü¶ä Updating environment after checkout..."
node scripts/maintain-environment.mjs

exit 0
`;

function installHook(name, content) {
  const hookPath = join(hooksDir, name);
  try {
    writeFileSync(hookPath, content, { mode: 0o755 });
    chmodSync(hookPath, 0o755);
    console.log(`‚úÖ Installed ${name} hook`);
  } catch (error) {
    console.error(`‚ùå Failed to install ${name} hook:`, error.message);
  }
}

console.log('üîß Installing git hooks for automatic environment maintenance...\n');

installHook('pre-commit', preCommitHook);
installHook('post-merge', postMergeHook);
installHook('post-checkout', postCheckoutHook);

console.log('\n‚úÖ Git hooks installed successfully!');
console.log('   Your environment will now be maintained automatically.\n');
console.log('To uninstall, delete the hook files in .git/hooks/\n');
